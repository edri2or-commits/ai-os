# LHO Database - Learned Heuristic Objects

## What is this?

**LHO (Learned Heuristic Object)** = A learned rule that prevents future errors.

When the AI makes a mistake and the user corrects it, the **Slow Loop** (Judge ‚Üí Teacher ‚Üí Librarian) converts that correction into an LHO and stores it here.

**Next time:** The **Context Manager** retrieves relevant LHOs and injects them into the System Prompt ‚Üí **Error prevented ‚úì**

---

## Structure

```
truth-layer/lhos/
‚îú‚îÄ‚îÄ LHO-001.json          # Individual LHO files
‚îú‚îÄ‚îÄ LHO-002.json
‚îú‚îÄ‚îÄ INDEX.md              # Human-readable index (auto-generated by Librarian)
‚îî‚îÄ‚îÄ ...
```

**Storage:**
- **Files:** `truth-layer/lhos/*.json` (Git-tracked, human-readable)
- **Vector DB:** Qdrant `lhos` collection (semantic search)

---

## LHO Schema

See: `life-graph/schemas/lho_schema.json`

**Required fields:**
- `lho_id`: Unique ID (e.g., "LHO-001")
- `title`: Human-readable summary
- `trigger_pattern`: When to apply (semantic condition)
- `correction_strategy`: What to do instead (actionable instruction)
- `priority`: critical | high | medium | low
- `created_at`: ISO 8601 timestamp

**Optional fields:**
- `faux_pas_source`: ID of FauxPas_Report that triggered this LHO
- `success_count`: Number of times LHO prevented error
- `tags`: Categories for filtering (csv, file_operations, safety, etc.)
- `archived`: If true, LHO is obsolete

---

## Example: LHO-001

```json
{
  "lho_id": "LHO-001",
  "title": "Always use Python tool for CSV parsing",
  "trigger_pattern": "task contains 'CSV' OR file_extension == '.csv'",
  "correction_strategy": "Use python_csv MCP tool, not regex. Handles edge cases.",
  "priority": "high",
  "tags": ["csv", "file_operations"]
}
```

**What it does:**
- **Before:** AI tries to parse CSV with regex ‚Üí fails on quoted commas
- **After:** Context Manager injects LHO-001 ‚Üí AI uses python_csv tool ‚Üí succeeds ‚úì

---

## How LHOs are Created

**Automatic (Slow Loop):**
1. **Judge Agent** scans EVENT_TIMELINE.jsonl for errors (every 6 hours)
2. **Teacher Agent** converts error into LHO (GPT-4o or Claude API)
3. **Librarian Agent** indexes LHO in Qdrant + updates INDEX.md
4. **Telegram notification:** "üß† Learned new rule: {title}"

**Manual (for testing):**
```bash
# 1. Create JSON file
echo '{ "lho_id": "LHO-002", ... }' > truth-layer/lhos/LHO-002.json

# 2. Insert into Qdrant (with embedding)
python tools/insert_lho.py LHO-002
```

---

## Tools

**Create Collection:**
```bash
python tools/create_lho_collection.py
# Output: Qdrant collection 'lhos' (1536-dim vectors, COSINE distance)
```

**Insert LHO:**
```bash
python tools/insert_lho_001.py
# Output: LHO-001 inserted with dummy vector (will be replaced by real embedding)
```

**Test Retrieval:**
```bash
python tools/test_lho_retrieval.py
# Output: Lists all LHOs, filters by tag 'csv'
```

**Query by Keyword (Future - requires embeddings):**
```python
from qdrant_client import QdrantClient

client = QdrantClient("localhost", 6333)
results = client.search(
    collection_name="lhos",
    query_vector=get_embedding("CSV parsing"),  # OpenAI API
    limit=3
)
```

---

## Current Status (Slice 2.5.2 Complete)

‚úÖ **Schema defined:** `life-graph/schemas/lho_schema.json`  
‚úÖ **Qdrant collection created:** `lhos` (1536-dim, COSINE)  
‚úÖ **LHO-001 inserted:** Example rule (CSV parsing)  
‚úÖ **Retrieval tested:** Payload filtering works (tag-based search)  

‚ùå **Embeddings:** Not yet (requires OpenAI API key in Teacher Agent)  
‚ùå **Context Manager:** Not yet (Slice 2.5.6)  
‚ùå **Judge/Teacher/Librarian:** Not yet (Slices 2.5.3-2.5.5)  

---

## Next Steps (Phase 2.5 Roadmap)

**Slice 2.5.3:** Judge Agent (n8n workflow, error detection)  
**Slice 2.5.4:** Teacher Agent (error ‚Üí LHO conversion)  
**Slice 2.5.5:** Librarian Agent (indexing + deduplication)  
**Slice 2.5.6:** Context Manager (JIT LHO injection)  
**Slice 2.5.7:** End-to-End Test (prove system learns)

---

**Last Updated:** 2025-12-04  
**Slice:** 2.5.2 (LHO Database Schema)  
**Status:** Foundation complete, ready for Slow Loop integration